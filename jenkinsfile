pipeline {
    agent any
    tools {
        jdk 'jdk11'
        maven 'maven3'
    }
    environment {
        NEXUS_REGISTRY = 'http://172.17.7.99:8082'
        DOCKER_IMAGE_NAME = 'boardgame-app'
        K8S_NAMESPACE = 'boardgame'
        K8S_MASTER = 'https://172.17.7.95:6443'
    }
    stages {
        stage('Git Checkout') {
            steps {
                sh '''
                    echo "=== Cleaning workspace ==="
                    rm -rf *
                    rm -rf .* 2>/dev/null || true
                    echo "=== Cloning repository ==="
                    git clone https://github.com/killsmokker/ak-cicd.git .
                    echo "=== Repository contents ==="
                    ls -la
                '''
            }
        }
        stage('Compile') {
            steps {
                sh 'mvn compile'
            }
        }
        stage('Test') {
            steps {
                sh 'mvn test'
            }
        }
        stage('Build Package') {
            steps {
                sh 'mvn clean package -DskipTests'
            }
        }
        stage('Build Docker Image') {
            steps {
                script {
                    withDockerRegistry(credentialsId: 'nexus', toolName: 'docker') {
                        sh """
                            docker build -t ${NEXUS_REGISTRY}/docker-hosted/${DOCKER_IMAGE_NAME}:latest .
                        """
                    }
                }
            }
        }
        stage('Deploy to Kubernetes') {
            steps {
                withKubeConfig(credentialsId: 'kubeconfig', namespace: "${K8S_NAMESPACE}", serverUrl: "${K8S_MASTER}") {
                    sh """
                        kubectl apply -f k8s-deployment.yaml -n ${K8S_NAMESPACE}
                        kubectl apply -f k8s-service.yaml -n ${K8S_NAMESPACE}
                        kubectl apply -f k8s-ingress.yaml -n ${K8S_NAMESPACE}
                        echo "=== Deployment Status ==="
                        kubectl get pods -n ${K8S_NAMESPACE}
                    """
                }
            }
        }
    }
    post {
        success {
            echo "üéâ SUCCESS! BoardGame app deployed!"
            echo "üåê Access at: http://boardgame.172.17.7.95.nip.io"
            echo "üë§ Test users: bugs/bunny (user) | daffy/duck (manager)"
        }
        failure {
            echo "‚ùå Pipeline failed! Check logs above."
        }
    }
}
